# 网络层

## 网络层简介

主要任务：将分组从源端发送至目的端

传输单位：数据报（数据报经过划分变为分组）

1. 异构网络互联

   通过路由器进行网络互联以及路由选择

2. 路由转发（主要任务）

   两项主要功能：路由选择，分组转发

   路由选择：根据相邻节点的情况动态的选择路由

   分组转发：将接收到的$IP$数据报从合适的端口转发

3. $SDN$——中心化的路由选择

   我们将网络层抽象为**数据平面**以及**控制平面**的集合，其中数据平面实现**转发**的功能，控制平面实现**路由选择**的功能。

   传统的网络层将两个任务都交给路由器完成，但$SDN$中控制平面的工作交给了**远程控制器**，从而简化了路由器的工作。

   $SDN$中的三类接口：北向接口，南向接口，东西向接口

   北向接口：向上向**操作员**提供编程接口

   南向接口：向下与$SDN$**控制器和转发设备**建立双向会话接口

   东西向接口：平行与$SDN$控制器集群内部**其他控制器**通信接口

4. 拥塞控制

   拥塞：通信子网中，出现过量分组引发网络性能下降

   拥塞控制与流量控制的不同性在于拥塞控制是一个**全局性**控制，而流量控制只会控制**点对点**的通信量。

   拥塞控制的两种方式：开环控制，闭环控制

   开环控制：**静态**预防方式，网络设计之初考虑周到通过**合理的设计**减少拥塞

   闭环控制：**动态**预防方式，通过**监测**检查拥塞的发生而后调节系统的流量分配

## $IPv4$

### 格式

1. 版本，指定$IP$协议版本（$4bit$）
2. 首部长度，以$4B$为单位，最少也是最常用的是$20B$，最多$60B$（$4bit$）
3. 总长度，以$1B$为单位，首部和数据之和长度（$16bit$）
4. 标识，每产生一个数据报就要增加$1$，同一数据报产生的分片都是同一标识的（$16bit$）
5. 标志，最高位无意义，中间位$DF$（$Don't\ Fragment$），只有$DF=0$表示允许分片，末位$MF$（$More\ Fragment$），$MF=1$表示后面还有分片（$3bit$）
6. 片偏移，以$8B$为单位，表示当前分片距离头部的相对位置（$13bit$）
7. 生存时间（$TTL$），每经过一个路由器$TTL$减一，如果接收到$TTL=0$的分组路由器将丢弃该分组，防止出现永远无法交付的分组（$8bit$）
8. 协议，表明使用的协议类型，$UDP$表示$17$，$TCP$表示$6$（$8bit$）
9. 首部校验和，校验分组的首部（$16bit$）
10. 源地址目的地址字段，表示发送方和接收方的$IP$地址（$32bit$）

三个单位要求：首部长度——$4B$，总长度——$1B$，片偏移——$8B$     $1$总（长度）$8$片（偏移）首（部长度）$4$

### 分片

因为存在$MTU$，所以要求数据报必需分片之后再发送

1. 分片之后的数据报**长度**必须是$8B$的倍数
2. 分片之后的数据报除了最后一份其余的$MF$必须都是$1$
3. 分片之后的数据报要求**片偏移量**计算正确
4. 分片之后的数据报都应该在符合$MTU$的情况下尽量长

### 网络、网络号以及特殊网络号

$IP$地址$=$网络号$+$主机号

#### $IP$地址分类

$A$类：开头为$0$，单播地址

$B$类：开头为$10$，单播地址

$C$类：开头为$110$，单播地址

$D$类：开头为$1110$，多播地址

$E$类：开头为$1111$，今后使用

#### 特殊$IP$地址

| 网络号 | 主机号         | 源地址 | 目的地址 | 代表意思                          |
| ------ | -------------- | ------ | -------- | --------------------------------- |
| $0$    | $0$            | 可以   | 不可     | 本网络上的本主机                  |
| $0$    | $X$            | 可以   | 不可     | 本网络上主机号为$X$的主机         |
| 全$1$  | 全$1$          | 不可   | 可以     | 在本网络上广播                    |
| $Y$    | 全$1$          | 不可   | 可以     | 对网络号为$Y$的网络上所有主机广播 |
| $127$  | 非全$0$非全$1$ | 可以   | 可以     | 本地软件环回测试                  |

#### 私有$IP$地址

| 网络类型  | 网络数量 | 网络号范围                 | $IP$地址范围                     |
| --------- | -------- | -------------------------- | -------------------------------- |
| $A$类网络 | $1$      | $10\sim 10$                | $10.0.0.0\sim10.255.255.255$     |
| $B$类网络 | $16$     | $172.16\sim172.31$         | $172.16.0.0\sim172.31.255.255$   |
| $C$类网络 | $256$    | $192.168.0\sim192.168.255$ | $192.168.0.0\sim192.168.255.255$ |

#### 三种$IP$地址使用范围

| 网络类别 | 最大可用网络数 | 第一个可用的网络号 | 最后一个可用的网络号 | 每个网络中最大的主机数 |
| -------- | -------------- | ------------------ | -------------------- | ---------------------- |
| $A$      | $2^7-2$        | $1$                | $126$                | $2^{24}-2$             |
| $B$      | $2^{14}$       | $128.0$            | $191.255$            | $2^{16}-2$             |
| $C$      | $2^{21}$       | $192.0.0$          | $223.255.255$        | $2^8-2$                |

### $NAT$

将专用网络地址转换为公用地址从而隐藏内部管理的$IP$地址

通过$NAT$转换表将主机端口号转换为路由器端口号从而使得多个主机共享同一个路由器的$IP$地址

### 子网划分与$CIDR$

如果仅仅只是使用$ABC$三类网络就会出现使用不够灵活导致的地址浪费等问题，为了解决这个问题我们引进了**子网划分技术**

**子网划分技术**将主机号中的高位分配给子网号，将原来$IP$地址的$网络号-主机号$结构拓展为$网络号-子网号-主机号$结构

为了清楚的辨析子网划分技术下的网络号以及子网号我们需要引入**子网掩码**，即从高位开始长度为$k$的$1$串，来进行区分

可以考虑到的是仅通过**子网掩码**的长度我们就能够得到一个主机所在网络的网络号。因此我们能够通过**变长子网掩码**来提出一种新的网络划分，即在软件支持下的**超网划分**。

$IP$地址记法：斜线记法

路由聚合：将多个子网合并成

最长前缀匹配：路由表中可能存在多个网络号符合需要查询的地址，我们采用**子网掩码最长**的一位作为目的地

### $ARP$

主要解决如何**通过$IP$地址得到$MAC$地址**以方便链路层封装的问题

工作原理：路由器中存在一个$ARP$表存着不同$IP$地址对应$MAC$地址的信息。如果需要发送数据报首先查看$ARP$表上是否有对应的$MAC$地址，如果没有通过**广播**$ARP$请求报文得到$MAC$地址。

需要注意的是$ARP$报文仅请求下一跳的$MAC$地址，如果当前节点与目的主机非同一网络，那么$ARP$就将请求默认路由的$MAC$地址

### $DHCP$

#### 静态配置和动态配置的辨析

静态配置：$IP$，子网掩码，默认网关手动配置

动态配置：以上三者通过$DHCP$服务动态配置

$DHCP$是一个基于$UDP$的**应用层**协议，向用户提供了**即插即用**的联网机制

1. 主机广播“$DHCP$发现”消息，试图发现发现$DHCP$服务器，源地址$0.0.0.0$，目的地址$255.255.255.255$
2. $DHCP$服务器广播“$DHCP$提供”消息，包含$DHCP$提供的$IP$地址，源地址$DHCP$服务器地址，目的地址$255.255.255.255$
3. 主机广播“$DHCP$请求”消息，向$DHCP$服务器请求对$IP$地址的确认，源地址$0.0.0.0$，目的地址$255.255.255.255$
4. $DHCP$服务器广播“$DHCP$确认”消息，将$IP$地址分配给主机，源地址$DHCP$服务器地址，目的地址$255.255.255.255$

### $ICMP$

通过网际控制报文协议让主机或路由器**报告差错**和**异常情况**

$ICMP$报文种类有两种：**$ICMP$差错报告报文**和**$ICMP$询问报文**

#### $ICMP$差错报告报文

##### 发送的五个情况

1. 终点不可达

   路由器或主机不能向上交付数据报

2. 源点抑制

   路由器或主机由于过于拥塞丢弃数据报

3. 时间超过

   路由器收到$TTL$为$0$的数据报

   主机在规定时间内没有收集到数据报所有的分片

4. 参数问题

   路由器或主机收到数据报中首部字段错误

5. 改变路由

   在出现更优的路由的情况下路由器发送概念路由报文

##### 不用发送的四个情况

1. **$ICMP$差错报文**不再发送$ICMP$差错报文
2. 不对**特殊地址**（$127.0.0.1$）发送$ICMP$差错报文
3. 不对**组播地址**发送$ICMP$差错报文
4. 不对第一个分片的数据报片的**后续数据报片**发送$ICMP$差错报文

#### $ICMP$询问报文

四个种类：$\textcolor{red}{回送请求和回答报文}$、$\textcolor{red}{时间戳请求和回答报文}$、$地址掩码请求和回答报文$、$路由器询问和通告报文$

回送请求和回答报文：询问是否可达

时间戳请求和回答报文：时钟同步和测量时间

## $IPv6$

为了解决$IPv4$能够分配地址有限的问题引入了$IPv6$

1. 版本字段，$6$，$4bit$
2. 优先级，将其与别的普通报文区分开，$8bit$
3. 流标签，共同发送的一系列数据报使用同一个流标签，$20bit$
4. 有效载荷长度，单位$1B$，$16bit$
5. 下一个首部，每个首部或者拓展首部中都有一个下一个首部字段，指向下一个拓展首部，如果是后面没有拓展首部了那就指向数据部分
6. 跳数限制，即原来的$TTL$字段，$8bit$
7. 目的地址以及源地址字段，相较于$IPv4$拓展到$128bit$

### $IPv6$与$IPv4$不同

1. 拓展首部长度，$128bit$
2. 取消可选字段，变成拓展首部，加快了路由器处理速度
3. 即插即用
4. 只能在主机分片（路由器没有分片功能）
5. $ICMPv6$出现分组过大问题
6. 取消校验和字段
7. 长度必须是$8B$的整数倍
8. 取消协议字段采用下一首部字段，将拓展首部放入数据部分中
9. 取消总长度字段，只有有效载荷长度字段，首部长度固定为$40B$
10. 取消服务类型字段

### 地址三种类型

$IPv6$地址分为**单播**，**多播**以及**任播**类型

单播：传统**点对点**

多播：一点对多点

任播：发送给一组计算机中的任意一个

### $IPv6$地址表示法

1. 每$4$位采用一个十六进制表示，每总共$16$位用冒号分隔
2. 如果十六位域开头为$0$可以省略但必须保证最少有一位数字
3. 如果有连续的$0$域值使用双冒号缩写

### $IPv4$向$IPv6$过渡

采用**双协议栈**以及**隧道技术**两种策略

双协议栈：同时装有$IPv4$以及$IPv6$两种协议栈，能同时进行$IPv4,IPv6$两种通信

隧道技术：如果$IPv6$数据报要进入$IPv4$网络，那么就将$IPv4$数据报分装进$IPv6$数据部分

## 路由系统

### 概念

自治系统：单一技术管理下的路由器，通常为一个行政单位管辖

内部网关协议（$IGP$）：自制系统内部的路由选择协议，如$RIP$或者$OSPF$

外部网关协议（$EGP$）：自制系统之间的路由选择协议，如$BGP$

### $RIP$

一种**分布式**的基于**距离向量**的路由选择协议，通过**跳数**度量路由器之间的距离进而找到最优路由路径

$RIP$要求一条路径最多包含$15$个路由器也就是最多$15$跳，举例显示为$16$时表示不可达，因此只适用于小型互联网

$RIP$为**应用层**协议，使用$UDP$传送数据（端口$520$）

> 路由器作为网络层设备是在为用户**转发数据报分组**时候的表现，在作为路由选择协议报文的发送端时与普通的主机没有任何区别

交换信息：每个路由器每隔$30s$与**相邻的路由器**使用$RIP$报文交换**自己的路由表**

#### 距离向量算法

路由表结构：目的网络$+$距离$+$下一跳路由器地址

假设现在$Y$接收到$X$的路由表，他将进行如下阶段：

1. 将距离全部加一，并将下一跳路由器地址修改为$X$
2. 对于路由表中的内容分类讨论
   1. 如果原来没有该目的网络的将其加入
   2. 如果原来该目的网络中的下一跳路由器地址为$X$的，直接替换
   3. 如果原来该目的网络中的距离大于修改过的路由器地址，直接替换
3. 如果超过$180s$没有接收到$RIP$报文，默认不可达，把距离设置为$16$

#### 坏消息传得慢

如果$A$相连的$B$网络损坏，$A$将会显示$B$网络损坏，但相邻的$C$网络会告诉$A$自己对$B$可达（就是之前经过$A$的路），于是两者就开始相互传送$B$可达的消息并替代对方的路由表直到$16$的时候才会显示不可达。

### $OSPF$

使用**分布式链路状态**路由算法的典型代表

**相邻链路状态**变化时，路由器向自治系统中其他路由器**洪泛**发送本路由器相邻的**路由器链路状态**，最后所有的路由器都能建立一个自己的**链路状态数据库**，而后通过$dijkstra$最短路径算法得到最优路线

为了限制洪泛的区域$OSPF$将每个自治区域划分为更小的范围，成为**区域**，每个路由器只用负责自己所在的区域的路由就好了

每隔一段时间（一般为$20$分钟）或者链路状态发生变化被路由器记录那么该路由器就将通过洪泛法通知本机的变化

1. 发送**问候分组**检查邻站的可达性
2. 发送**数据库描述分组**提供数据库摘要信息
3. 发送**链路状态请求分组**请求链路状态项目详细信息（发现对方数据库描述与我不同）
4. 洪泛发送**链路状态更新分组**对全网链路状态更新
5. 发送**链路状态确认分组**对链路状态更新分组表示确认

### $BGP$

$BGP$是一个基于$TCP$的**应用层**协议，采用**路径向量路由选择算法**实现不同$AS$之间路由器交换路由信息

$BGP$协议允许每个$AS$选择最少一个$BGP$发言人与其他的$BGP$发言人交换路由信息。先建立$TCP$连接，将$BGP$报文作为$TCP$报文的数据部分发送而后通过$BGP$报文建立的会话交换路由信息

发生变化的时候，$AS$的邻站$BGP$发言人（$AS$与外界连接的路由器）与其他$AS$的$BGP$发言人交换**网络可达性信息**，即到达某个网络经过的**一系列$AS$**

#### $BGP$四种报文

1. 打开报文，与另一个$BGP$发言人**建立关系**
2. 更新报文，发送**添加**或者**删除**的路由信息
3. 保活报文，确认**打开报文**以及**周期性**证实邻站关系
4. 通知报文，发送检测到的**错误**

#### $BGP$特点

1. $BGP$支持$CIDR$
2. $BGP$刚运行的时候邻站发送**整个**路由表后面只需要发生变化的时候更新**有变化**的部分

### $RIP,OSPF$以及$BGP$三种协议比较

| 协议     | $RIP$        | $OSPF$                           | $BGP$                                    |
| -------- | ------------ | -------------------------------- | ---------------------------------------- |
| 类型     | $IGP$        | $IGP$                            | $EGP$                                    |
| 路由算法 | 距离-向量    | 链路状态                         | 路径-向量                                |
| 传递协议 | $UDP$        | $IP$                             | $TCP$                                    |
| 路径选择 | 跳数最少     | 代价最低                         | 较好，非最佳                             |
| 交换节点 | 相邻路由器   | 网络中所有路由器                 | 相邻路由器                               |
| 交换内容 | 自己的路由表 | 本路由器相邻所有路由器的链路信息 | 首次发送整个路由表，之后只发送变化的部分 |

## $IP$组播

源主机发送**一个**数据报但有**多个**目的主机收到该数据报，收到数据报的主机都拥有同一个**组播地址**。

$IP$组播使用$D$类地址格式，以$1110$开头，每个$D$类组播地址都对应了一个**组播组**。

1. 组播数据报通过$UDP$协议实现不可靠传输
2. 组播地址只能用于目的地址，不能用于源地址
3. 组播数据报不产生$ICMP$数据报
4. 并非所有$D$类地址都能作为组播地址
   - $224.0.0.0$ 基准地址
   - $224.0.0.1$ 所有主机地址
   - $224.0.0.2$ 所有组播路由器地址
   - 等等

$IP$组播分为**只在本地局域网上进行硬件组播**以及**在因特网范围内进行组播**

### 硬件组播

组播$MAC$起始$6$位固定为为$01-00-5E$，后$6$位范围为$00-00-00$到$7F-FF-FF$，由组播$IP$地址后$23$位映射而来

组播$IP$高$4$位为固定$1110$，低$23$位映射到$MAC$地址，而中间$5$位并没有体现，也就是说会出现$IP$不同但组播$MAC$相同的情况，为了防止这种情况影响正常使用我们还将在**$IP$层**通过软件**过滤**

### $IGMP$与组播路由算法

因特网上传输**组播数据报**的时候组播路由器之间需要协同工作以便通过**最小代价**将其传送给所有组成员，因此我们引入$IGMP$协议

$IGMP$协议是$IP$协议的一个组成部分

1. 当某个主机刚刚加入一个新的组播组时向该组播地址发送一个$IGMP$报文来表达自己成为这个组播组的成员，本地组播路由器在收到该$IGMP$报文之后将**组成员关系**转发给其他组播路由器
2. 本地组播路由器周期性探索本地局域网上的主机，如果一个组中有一台主机响应那么表明这个组仍然活跃，如果没有响应，那么的话不再将**组成员关系**转发给其他组播路由器

> 组成员关系：该路由器相连的主机中是否存在该主机

组播路由选择构建了一棵**组播转发树**（保证不会出现环），树的叶节点上是包含组播主机的路由器

可以理解的是不同的**多播组**以及不同的**源点**对应不同的**多播转发树**

路由选择协议：基于**链路状态**的路由选择，基于**距离-向量**的路由选择，**协议无关**的组播（对应三种路由选择协议）

## 移动$IP$

不同网段中使用相同的$IP$地址，以此来实现**漫游**功能

### 动态$IP$与移动$IP$辨析

动态$IP$：分配一个新的$IP$，将本地代理即作为归属代理，现在常常与$NAT$相关联

移动$IP$：无论在哪个外地网络中，都会与原有的归属网络产生联系

### 概念

移动节点：永久$IP$地址的移动站（参考智能手机）

本地代理（归属代理）：归属网络上的路由器

外地代理：被访网络上的路由器

永久地址：移动节点在归属网络上的地址

转交地址：移动节点在外地网络上的地址

### 过程

- 进入外部网络

  在**外地代理**处登记获得一个转交地址，并向**归属代理**处登记该转交地址

- 接收

  1. 归属代理接收到$IP$数据报之后进行**再封装**，并通过先前构建的**通向转交地址的隧道**转交给被访网络的外地代理
  2. 外地代理将收到的数据拆封还原成原来的数据报并交付给移动主机

- 发送

  将自己的永久地址作为**源$IP$**直接通过自己的所属的**外地代理**发送

- 到新网络

  移动到另一外地网络后将原来的流程再进行一遍，并将原有的隧道覆盖了

- 回到归属网络

  回到归属网络后，注销转交地址

## 路由器

### 组成以及功能

具有**多个输入/输出端口**的专用计算机，起到**连接不同网络**以及**路由转发**的作用

结构上分为**路由选择部分**以及**分组转发部分**

- 路由选择

  根据选定的路由选择协议**构造**出路由表同时通过交换路由信息**更新**路由表

- 分组转发

  分为三个部分：交换结构、一组输入端口以及一组输出端口

  **交换结构**根据转发表将某个**输入端口**得到的分组从一个**输出端口**转发出去

**分组丢失**的重要原因：输入/输出队列溢出

### 路由表与路由转发

路由表$4$个项目：目的网络$IP$地址，子网掩码，下一跳$IP$地址，接口

转发表$2$个项目：目的地址，下一跳$MAC$地址

**转发表**是通过**路由表**得来

### 三种层次设备辨析

路由器（网络层）：互联两个不同网络层协议网段

网桥（链路层）：互联两个不同物理层链路层协议网段

集线器（物理层）：不能互联物理层协议不同网段

