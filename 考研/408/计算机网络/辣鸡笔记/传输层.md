# 传输层

## 传输层的功能

1. 提供**进程**之间的逻辑通信

2. **复用**和**分用**

   复用：不同进程之间使用同一个传输层协议

   分用：接收方剥去报文首部之后将这些数据正确交付

3. 对报文进行**差错检测**

4. 提供两种不同的传输协议，即$TCP$与$UDP$

   $TCP$：可靠，面向连接，时延大，适用于大文件

   $UDP$：不可靠，无连接，时延小，适用于小文件

## 传输层寻址

$SAP$：可以理解为某一层次中的唯一标识

数据链路层的$SAP$是$MAC$地址，网络层的$SAP$是$IP$地址，传输层的$SAP$是端口

> 硬件端口：不同硬件设备之间交互的接口
>
> 软件端口：应用层个协议进行的交换地址

### 端口

- 服务器使用的端口号

  1. 熟知端口号

     用于$TCP/IP$最重要的应用程序（$0\sim1023$）

     | 应用程序   | $FTP$ | $TELNET$ | $SMTP$ | $DNS$ | $TFTP$ | $HTTP$ | $SNMP$ |
     | ---------- | ----- | -------- | ------ | ----- | ------ | ------ | ------ |
     | 熟知端口号 | $21$  | $23$     | $25$   | $53$  | $69$   | $80$   | $161$  |

  2. 登记端口号

     提供给没有熟知端口号的应用程序使用（$1024\sim49151$）

- 客户端使用的端口号

  客户进程运行时候动态选择（$49152\sim65535$）

### 套接字

将进程所在主机的**$IP$地址**与进程的**端口号**组合，组成**套接字**，用于唯一标识**通信端**

## $UDP$

在$IP$数据报的基础上增加了两个基本的服务：**复用与分用**以及**差错检测**

1. 无连接，减少时延
2. 不保证可靠连接
3. 面向报文
4. 适合一次性传输少量数据
5. 无拥塞控制
6. 首部开销小（$8B$）

### 首部格式

1. 源端口，回信的时候使用，不回信可使用全$0$（$2B$）

2. 目的端口，交付报文时候使用（$2B$）

   如果分用过程中找不到目的端口号，返回$ICMP$“端口不可达”报文

3. 长度，$UDP$数据报长度，最小值为$8$，单位$1B$（$2B$）

4. 校验和，不计算校验和全置为$0$

### $UDP$校验

#### 发送方流程

1. 将**全零**放入校验和字段并添加**伪首部**

   伪首部格式：源$IP$地址（$4B$），目的$IP$地址（$4B$），全$0$（$1B$），协议字段（$1B$），$UDP$长度（$2B$）

2. 如果数据部分不是**偶数**个字节长度添加一个全零字节

3. 按照**二进制反码**的规则计算出这些$16$位字的和，将其**反码**写入校验和字段

#### 接收方流程

1. 给收到的$UDP$数据报添加**伪首部**
2. 按照**二进制反码**的规则计算出这些$16$位字的和
3. 如果答案为全$1$说明正确，否则直接丢弃

## $TCP$

1. 通过构建**逻辑连接**（$TCP$连接）来实现**面向连接**的**传输层**协议

2. **一对一**服务

3. 提供**可靠交付**的服务

4. **全双工**通信

   双方都设有发送缓存以及接收缓存

   发送缓存：准备发送的数据以及已经发送但没有确认的数据

   接受缓存：尚未被应用程序读取的数据以及不按序到达的数据

5. 面向**字节流**的数据

### 报文段

1. 源端口以及目的端口（$2B$）

   传输层的服务接口，传输层**复用**和**分用**功能的实现

2. 序号（$4B$）

   本报文段发送数据的**第一个字节序号**

3. 确认号（$4B$）

   假设确认号为$N$表示接下来希望接收到序号为$N$的报文并表示$N-1$号之前的数据都已经被接收完成

4. 数据偏移（$4bit$）

   $TCP$数据起始处相对于报文起始处的长度，也就是**首部长度**，单位$4B$

5. 保留（$6bit$）

   保留为今后使用，置$0$

6. 紧急位$URG$（$1bit$）

   $URG=1$表示**紧急指针**字段有效，应尽快传送

7. 确认位$ACK$（$1bit$）

   $ACK=1$表示确认号**字段有效

8. 推送位$PSH$（$1bit$）

   当前数据报尽快交付

9. 复位位$RST$（$1bit$）

   $TCP$连接出现严重差错需要重新建立运输连接

10. 同步位（$1bit$）

    **请求连接**以及**接收连接**报文

11. 终止位$FIN$（$1bit$）

    $FIN=1$表示发送方数据发送完毕

12. 窗口（$2B$）

    接收方的**接收窗口**大小，也是下一批次发送数据的大小

13. 校验和（$2B$）

    类似$UDP$校验和计算方式

14. 紧急指针（$2B$）

    表示从必定起始于报文段最前方的紧急数据的长度

15. 选项

16. 填充

    整个首部长度为$4B$

#### $URG$与$PSH$辨析

$URG$：表示当前数据报应当尽快发送

$PSH$：表示当前数据报在接收后应当尽快交付

### $TCP$连接管理

#### $TCP$三次握手

采用**客户/服务器模式**

> 客户：主动发起连接的应用进程
>
> 服务器：被动等待连接建立的进程

1. 客户机$TCP$向服务器$TCP$发送**连接请求报文**

   $SYN=1,seq=x$

2. 服务器接收后如果同意建立连接，向客户机**发回确认**并为该$TCP$分配**缓存和变量**

   $ACK=1,SYN=1,ack=x+1,seq=y$

3. 客户机收到确认报文向服务器给出确认

   $ACK=1,SYN=0,ack=y+1,seq=x+1$

#### $TCP$四次挥手

1. 客户机发送**连接释放报文段**

   $FIN=1,seq=u$

2. 服务器收到后发出**确认**并继续发送为发送完成数据

   $ACK=1,ack=u+1,seq=v$

3. 服务器发送完是数据后通知$TCP$**释放连接**

   $FIN=1,ACK=1,ack=u+1,seq=w$

4. 客户机收到后发出**确认**

   $ACK=1,ack=w+1,seq=u+1$

### 可靠传输

可靠：保证**接收方**从缓存区中独处的字节流与**发送方**发出的字节流完全一样

$TCP$通过**校验**、**序号**、**确认**以及**重传**等机制来达到这个目的

1. 序号

   每个字节都有编号，序号字段的值是报文第一个字节的序号

2. 确认

   通过**确认报文**以及**确认号**实现，确认报文超时则重传

3. 重传

   超时以及冗余$ACK$将会产生重传

   - 超时

     通过**自适应算法**计算加权平均往返时间$RTT_S$

     > 自适应算法：之前发送的报文的$RTT$时间取平均

   - 冗余$ACK$

     多次收到同一$ACK$

### 流量控制

目的：消除接收方**缓存区溢出**的可能

定义：基于**滑动窗口协议**的流量控制机制

发送方通过修改确认报文中的窗口字段的值来告知发送方当前的接收窗口

#### 传输层与数据链路层流量控制区别

传输层：端到端两个用户之间的流量控制，窗口大小能够动态变化

链路层：点到点之间的流量控制，窗口大小固定

#### 返回窗口值为$0$的报文

以防收到窗口值为$0$的报文之后启动持续计时器，持续计时器到期后发送零窗口探测报文段，接收方返回当前接收窗口的大小

如果仍然为$0$重复上述过程

### 拥塞控制

拥塞：随着网络负载的上升，**通信时延**增加

#### 拥塞控制与流量控制之间区别

拥塞控制：发送端为了照顾**网络的传输上限**（路由器排队等问题）对自己进行控制

流量控制：发送端为了照顾**接收端的接收上限**对自己进行控制

#### 接收窗口与拥塞窗口

接收窗口：接收方反应自身情况并告知发送方

拥塞窗口：发送方估算网络拥塞情况设置窗口值
$$
W_{发送}=min(W_{接收},W_{拥塞})
$$

### 维护方式

基本方式分为**慢开始**阶段以及**拥塞避免**阶段

1. 慢开始

   将拥塞窗口尺寸初始化为$1$，而后每个传输轮次都在原来的基础上乘以$2$，直到到达“慢开始门限”

   慢开始阶段的拥塞窗口大小不能超过慢开始门限，也就是说最后一个窗口增长将被慢开始门限限制

2. 拥塞避免

   在到达慢开始门限之后接下来拥塞窗口尺寸每个传输轮次增加$1$

   如果网络中出现拥塞那么之间将拥塞窗口的尺寸重置为$1$并将慢开始门限的限额定位出现拥塞时拥塞窗口大小的一半（不能小于$2$）

通过**快重传**以及**快恢复**算法对上述二者进行补充优化

1. 快重传

   收到三个重复的$ACK$报文直接判定为超时，立即重传

2. 快恢复

   收到三个重复的$ACK$报文将窗口大小调整至慢开始门限大小而后进入拥塞避免状态
